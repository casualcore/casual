
# casual domain protocol

[//]: # (Attention! this is a generated markdown from casual-gateway-markdown-protocol - do not edit this file!)

Defines what messages are sent between domains and exactly what they contain.

## version

Every message protocol definition will have a _protocol version range_ that defines witch versions 
of the protocol the message is part of.

The protocol version value, that is sent over the wire, is just an integer that starts at `1000` for `1.0`. 

The full table:

version | protocol value
--------|----------------------------
1.0     | 1000
1.1     | 1001
1.2     | 1002

## definitions

* `fixed array`: an array of fixed size where every element is an 8 bit byte.
* `dynamic array`: an array with dynamic size, where every element is an 8 bit byte.

If an attribute name has `element` in it, for example: `services.element.timeout`, the
data is part of an element in a container. You should read it as `container.element.attribute`

## sizes 

`casual` it self does not impose any size restriction on anything. Whatever the platform supports,`casual` is fine with.
There are however restrictions from the `xatmi` specification, regarding service names and such.

`casual` will not apply restriction on sizes unless some specification dictates it, or we got some
sort of proof that a size limitation is needed.

Hence, the maximum sizes below are huge, and it is unlikely that maximum sizes will 
actually work on systems known to `casual` today. But it might in the future... 


## message header 

This header will be the first part of every message below, hence it's name, _header_

message.type is used to dispatch to handler for that particular message, and knows how to (un)marshal and act on the message.

It's probably a good idea (probably the only way) to read the header only, to see how much more you have to read to get
the rest of the message.


role name          | network type   | network size | description                                  
------------------ | -------------- | ------------ | ---------------------------------------------
header.type        | uint64         |            8 | type of the message that the payload contains
header.correlation | (fixed) binary |           16 | correlation id of the message                
header.size        | uint64         |            8 | the size of the payload that follows         


## gateway_domain_connect_request - **#7200** - _[1.0, 1.1, 1.2]_

Connection requests from another domain that wants to connect

role name                 | network type   | network size | description                                            
------------------------- | -------------- | ------------ | -------------------------------------------------------
execution                 | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)     
domain.id                 | (fixed) binary |           16 | uuid of the outbound domain                            
domain.name.size          | uint64         |            8 | size of the outbound domain name                       
domain.name.data          | dynamic string |       [0..*] | dynamic byte array with the outbound domain name       
protocol.versions.size    | uint64         |            8 | number of protocol versions outbound domain can 'speak'
protocol.versions.element | uint64         |            8 | a protocol version                                     


## gateway_domain_connect_reply - **#7201** - _[1.0, 1.1, 1.2]_

Connection reply with the chosen _protocol version_

role name        | network type   | network size | description                                                       
---------------- | -------------- | ------------ | ------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                
domain.id        | (fixed) binary |           16 | uuid of the inbound domain                                        
domain.name.size | uint64         |            8 | size of the inbound domain name                                   
domain.name.data | dynamic string |       [0..*] | dynamic byte array with the inbound domain name                   
protocol.version | uint64         |            8 | the chosen protocol version to use, or invalid (0) if incompatible


## gateway_domain_disconnect_request - **#7202** - _[1.1, 1.2]_

Sent from inbound to connected outbound to notify that the connection is about to close, and outbound 
will stop sending new requests. Hence, the inbound can gracefully disconnect.

role name | network type   | network size | description                                       
--------- | -------------- | ------------ | --------------------------------------------------
execution | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)


## gateway_domain_disconnect_reply - **#7203** - _[1.1, 1.2]_

Confirmation that the outbound has got the disconnect request.

role name | network type   | network size | description                                       
--------- | -------------- | ------------ | --------------------------------------------------
execution | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)


## domain_discovery_request - **#7300** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain wants to discover information abut the other.

role name                     | network type   | network size | description                                                  
----------------------------- | -------------- | ------------ | -------------------------------------------------------------
execution                     | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)           
domain.id                     | (fixed) binary |           16 | uuid of the caller domain                                    
domain.name.size              | uint64         |            8 | size of the caller domain name                               
domain.name.data              | dynamic string |       [0..*] | dynamic byte array with the caller domain name               
content.services.size         | uint64         |            8 | number of requested services to follow (an array of services)
content.services.element.size | uint64         |            8 | size of the current service name                             
content.services.element.data | dynamic string |       [0..*] | dynamic byte array of the current service name               
content.queues.size           | uint64         |            8 | number of requested queues to follow (an array of queues)    
content.queues.element.size   | uint64         |            8 | size of the current queue name                               
content.queues.element.data   | dynamic string |       [0..*] | dynamic byte array of the current queue name                 


## domain_discovery_reply - **#7301** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain wants to discover information abut the other.

role name                                 | network type   | network size | description                                                     
----------------------------------------- | -------------- | ------------ | ----------------------------------------------------------------
execution                                 | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)              
domain.id                                 | (fixed) binary |           16 | uuid of the caller domain                                       
domain.name.size                          | uint64         |            8 | size of the caller domain name                                  
domain.name.data                          | dynamic string |       [0..*] | dynamic byte array with the caller domain name                  
content.services.size                     | uint64         |            8 | number of services to follow (an array of services)             
content.services.element.name.size        | uint64         |            8 | size of the current service name                                
content.services.element.name.data        | dynamic string |       [0..*] | dynamic byte array of the current service name                  
content.services.element.category.size    | uint64         |            8 | size of the current service category                            
content.services.element.category.data    | dynamic string |       [0..*] | dynamic byte array of the current service category              
content.services.element.transaction      | uint16         |            2 | service transaction mode (auto, atomic, join, none)             
content.services.element.timeout.duration | uint64         |            8 |                                                                 
content.services.element.hops             | uint64         |            8 | number of domain hops to the service (local services has 0 hops)
content.queues.size                       | uint64         |            8 | number of requested queues to follow (an array of queues)       
content.queues.element.name.size          | uint64         |            8 | size of the current queue name                                  
content.queues.element.name.data          | dynamic string |       [0..*] | dynamic byte array of the current queue name                    
content.queues.element.retries            | uint64         |            8 | how many 'retries' the queue has                                


## domain_discovery_topology_implicit_update - **#7302** - _[1.2]_

Sent to all inbound connections from a domain when when it gets a new connection or gets this message from an outbound.
When the message is passed "upstream" domains will add its id to the domains array, hence it's possible to mitigate endless 
loops of this message, depending on the topology of the deployment.

role name                 | network type   | network size | description                                                       
------------------------- | -------------- | ------------ | ------------------------------------------------------------------
execution                 | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                
domains.size              | uint64         |            8 | number of domains (an array of domains that has seen this message)
domains.element.id        | (fixed) binary |           16 | uuid of the domain                                                
domains.element.name.size | uint64         |            8 | size of the domain name                                           
domains.element.name.data | dynamic string |       [0..*] | dynamic byte array with the domain name                           


## service_call - **#3100** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain wants call a service in the other domain

role name                | network type   | network size | description                                                        
------------------------ | -------------- | ------------ | -------------------------------------------------------------------
execution                | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
service.name.size        | uint64         |            8 | service name size                                                  
service.name.data        | dynamic string |       [0..*] | byte array with service name                                       
service.timeout.duration | uint64         |            8 | timeout of the service in use (ns)                                 
parent.size              | uint64         |            8 | parent service name size                                           
parent.data              | dynamic string |       [0..*] | byte array with parent service name                                
xid.formatID             | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length         | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length         | uint64         |            8 | length of the transaction branch part                              
xid.data                 | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
flags                    | uint64         |            8 | XATMI flags sent to the service                                    
buffer.type.size         | uint64         |            8 | buffer type name size                                              
buffer.type.data         | dynamic string |       [0..*] | byte array with buffer type in the form 'type/subtype'             
buffer.data.size         | uint64         |            8 | buffer payload size (could be very big)                            
buffer.data.data         | dynamic binary |       [0..*] | buffer payload data (with the size of buffer.payload.size)         


## service_reply - **#3101** - _[1.0, 1.1, 1.2]_

Reply to call request

role name                    | network type   | network size | description                                                                   
---------------------------- | -------------- | ------------ | ------------------------------------------------------------------------------
execution                    | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                            
code.result                  | uint32         |            4 | XATMI result/error code, 0 represent OK                                       
code.user                    | uint64         |            8 | XATMI user supplied code                                                      
transaction.xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported           
transaction.xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                                          
transaction.xid.bqual_length | uint64         |            8 | length of the transaction branch part                                         
transaction.xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)             
transaction.state            | uint8          |            1 | state of the transaction TX_ACTIVE, TX_TIMEOUT_ROLLBACK_ONLY, TX_ROLLBACK_ONLY
buffer.type.size             | uint64         |            8 | buffer type name size                                                         
buffer.type.data             | dynamic string |       [0..*] | byte array with buffer type in the form 'type/subtype'                        
buffer.data.size             | uint64         |            8 | buffer payload size (could be very big)                                       
buffer.data.data             | dynamic binary |       [0..*] | buffer payload data (with the size of buffer.payload.size)                    


## transaction_resource_prepare_request - **#5201** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain wants to prepare a transaction. 

role name        | network type   | network size | description                                                        
---------------- | -------------- | ------------ | -------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length | uint64         |            8 | length of the transaction branch part                              
xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
resource         | uint32         |            4 | RM id of the resource - has to correlate with the reply            
flags            | uint64         |            8 | XA flags to be forward to the resource                             


## transaction_resource_prepare_reply - **#5202** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain is done preparing a transaction. 

role name        | network type   | network size | description                                                        
---------------- | -------------- | ------------ | -------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length | uint64         |            8 | length of the transaction branch part                              
xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
resource         | uint32         |            4 | RM id of the resource - has to correlate with the request          
state            | uint32         |            4 | The state of the operation - If successful XA_OK ( 0)              

### Resource commit



## transaction_resource_commit_request - **#5203** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain wants to commit an already prepared transaction.

role name        | network type   | network size | description                                                        
---------------- | -------------- | ------------ | -------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length | uint64         |            8 | length of the transaction branch part                              
xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
resource         | uint32         |            4 | RM id of the resource - has to correlate with the reply            
flags            | uint64         |            8 | XA flags to be forward to the resource                             


## transaction_resource_commit_reply - **#5204** - _[1.0, 1.1, 1.2]_

Reply to a commit request. 

role name        | network type   | network size | description                                                        
---------------- | -------------- | ------------ | -------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length | uint64         |            8 | length of the transaction branch part                              
xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
resource         | uint32         |            4 | RM id of the resource - has to correlate with the request          
state            | uint32         |            4 | The state of the operation - If successful XA_OK ( 0)              


## transaction_resource_rollback_request - **#5205** - _[1.0, 1.1, 1.2]_

Sent to and received from other domains when one domain wants to rollback an already prepared transaction.
That is, when one or more resources has failed to prepare.

role name        | network type   | network size | description                                                        
---------------- | -------------- | ------------ | -------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length | uint64         |            8 | length of the transaction branch part                              
xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
resource         | uint32         |            4 | RM id of the resource - has to correlate with the reply            
flags            | uint64         |            8 | XA flags to be forward to the resource                             


## transaction_resource_rollback_reply - **#5206** - _[1.0, 1.1, 1.2]_

Reply to a rollback request. 

role name        | network type   | network size | description                                                        
---------------- | -------------- | ------------ | -------------------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
xid.formatID     | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length | uint64         |            8 | length of the transaction branch part                              
xid.data         | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
resource         | uint32         |            4 | RM id of the resource - has to correlate with the request          
state            | uint32         |            4 | The state of the operation - If successful XA_OK ( 0)              


## queue_group_enqueue_request - **#6100** - _[1.0, 1.1, 1.2]_

Represent enqueue request.

role name                          | network type   | network size | description                                                        
---------------------------------- | -------------- | ------------ | -------------------------------------------------------------------
execution                          | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
name.size                          | uint64         |            8 | size of queue name                                                 
name.data                          | dynamic string |       [0..*] | data of queue name                                                 
xid.formatID                       | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length                   | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length                   | uint64         |            8 | length of the transaction branch part                              
xid.data                           | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
message.id                         | (fixed) binary |           16 | id of the message                                                  
message.attributes.properties.size | uint64         |            8 | length of message properties                                       
message.attributes.properties.data | dynamic string |       [0..*] | data of message properties                                         
message.attributes.reply.size      | uint64         |            8 | length of the reply queue                                          
message.attributes.reply.data      | dynamic string |       [0..*] | data of reply queue                                                
message.attributes.available       | uint64         |            8 | when the message is available for dequeue (us since epoch)         
message.payload.type.size          | uint64         |            8 | length of the type string                                          
message.payload.type.data          | dynamic string |       [0..*] | data of the type string                                            
message.payload.data.size          | uint64         |            8 | size of the payload                                                
message.payload.data.data          | dynamic binary |       [0..*] | data of the payload                                                


## queue_group_enqueue_reply - **#6101** - _[1.0, 1.1, 1.2]_

Represent enqueue reply.

role name | network type   | network size | description                                       
--------- | -------------- | ------------ | --------------------------------------------------
execution | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)
id        | (fixed) binary |           16 | id of the enqueued message                        


## queue_group_dequeue_request - **#6200** - _[1.0, 1.1, 1.2]_

Represent dequeue request.

role name                | network type   | network size | description                                                        
------------------------ | -------------- | ------------ | -------------------------------------------------------------------
execution                | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
name.size                | uint64         |            8 | size of the queue name                                             
name.data                | dynamic string |       [0..*] | data of the queue name                                             
xid.formatID             | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length         | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length         | uint64         |            8 | length of the transaction branch part                              
xid.data                 | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
selector.properties.size | uint64         |            8 | size of the selector properties (ignored if empty)                 
selector.properties.data | dynamic string |       [0..*] | data of the selector properties (ignored if empty)                 
selector.id              | (fixed) binary |           16 | selector uuid (ignored if 'empty'                                  
block                    | uint8          |            1 | dictates if this is a blocking call or not                         


## queue_group_dequeue_reply - **#6201** - _[1.0, 1.1, 1.2]_

Represent dequeue reply.

role name                                  | network type   | network size | description                                                
------------------------------------------ | -------------- | ------------ | -----------------------------------------------------------
execution                                  | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)         
message.size                               | uint64         |            8 | number of messages dequeued                                
message.element.id                         | (fixed) binary |           16 | id of the message                                          
message.element.attributes.properties.size | uint64         |            8 | length of message properties                               
message.element.attributes.properties.data | dynamic string |       [0..*] | data of message properties                                 
message.element.attributes.reply.size      | uint64         |            8 | length of the reply queue                                  
message.element.attributes.reply.data      | dynamic string |       [0..*] | data of reply queue                                        
message.element.attributes.available       | uint64         |            8 | when the message was available for dequeue (us since epoch)
message.element.payload.type.size          | uint64         |            8 | length of the type string                                  
message.element.payload.type.data          | dynamic string |       [0..*] | data of the type string                                    
message.element.payload.data.size          | uint64         |            8 | size of the payload                                        
message.element.payload.data.data          | dynamic binary |       [0..*] | data of the payload                                        
message.element.redelivered                | uint64         |            8 | how many times the message has been redelivered            
message.element.timestamp                  | uint64         |            8 | when the message was enqueued (us since epoch)             


## conversation_connect_request - **#3210** - _[1.0, 1.1, 1.2]_

Sent to establish a conversation

role name                | network type   | network size | description                                                        
------------------------ | -------------- | ------------ | -------------------------------------------------------------------
execution                | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)                 
service.name.size        | uint64         |            8 | size of the service name                                           
service.name.data        | dynamic string |       [0..*] | data of the service name                                           
service.timeout.duration | uint64         |            8 | timeout (in ns                                                     
parent.size              | uint64         |            8 | size of the parent service name (the caller)                       
parent.data              | dynamic string |       [0..*] | data of the parent service name (the caller)                       
xid.formatID             | uint64         |            8 | xid format type. if 0 no more information of the xid is transported
xid.gtrid_length         | uint64         |            8 | length of the transaction gtrid part                               
xid.bqual_length         | uint64         |            8 | length of the transaction branch part                              
xid.data                 | (fixed) binary |           32 | byte array with the size of gtrid_length + bqual_length (max 128)  
duplex                   | uint16         |            2 | in what duplex the callee shall enter (receive:1, send:0)          
buffer.type.size         | uint64         |            8 | buffer type name size                                              
buffer.type.data         | dynamic string |       [0..*] | byte array with buffer type in the form 'type/subtype'             
buffer.data.size         | uint64         |            8 | buffer payload size (could be very big)                            
buffer.data.data         | dynamic binary |       [0..*] | buffer payload data (with the size of buffer.payload.size)         


## conversation_connect_reply - **#3211** - _[1.0, 1.1, 1.2]_

Reply for a conversation

role name   | network type   | network size | description                                       
----------- | -------------- | ------------ | --------------------------------------------------
execution   | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)
code.result | uint32         |            4 | result code of the connection attempt             


## conversation_send - **#3212** - _[1.0, 1.1, 1.2]_

Represent a message sent 'over' an established connection

role name        | network type   | network size | description                                               
---------------- | -------------- | ------------ | ----------------------------------------------------------
execution        | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)        
duplex           | uint16         |            2 | in what duplex the callee shall enter (receive:1, send:0) 
code.result      | uint32         |            4 | status of the connection                                  
code.user        | uint64         |            8 | user code, if callee did a tpreturn and supplied user-code
buffer.type.size | uint64         |            8 | buffer type name size                                     
buffer.type.data | dynamic string |       [0..*] | byte array with buffer type in the form 'type/subtype'    
buffer.data.size | uint64         |            8 | buffer payload size (could be very big)                   
buffer.data.data | dynamic binary |       [0..*] | buffer payload data (with the size of buffer.payload.size)


## conversation_disconnect - **#3213** - _[1.0, 1.1, 1.2]_

Sent to abruptly disconnect the conversation

role name | network type   | network size | description                                       
--------- | -------------- | ------------ | --------------------------------------------------
execution | (fixed) binary |           16 | uuid of the current execution context (breadcrumb)

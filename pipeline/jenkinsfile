#!groovy

def backend_builder = '''#! /bin/sh
umask 000
cd /git/casual
rm -rf middleware/.casual/unittest/.singleton/.domain-singleton
casual-make make && casual-make clean && casual-make compile && casual-make link 
ISOLATED_UNITTEST_DIRECTIVES="--gtest_output='xml:report.xml'" casual-make test
casual-make install
cd /usr/local/casual
tar cvf /git/casual/casual-middleware.tar .
'''

def frontend_builder = '''#! /bin/sh
umask 000
cd /git/casual/webapp
bower update --allow-root
touch bower_components/app-route/app-location.html
polymer build
cd ..
zip -r casual-webapp.zip webapp
chmod a+w -R .
'''

def build( name, image, content)
{
   def current_dir = pwd()
   writeFile file: 'casual/builder.sh', text: content

   sh """
   chmod +x casual/builder.sh
   if docker ps -a | grep $name; then docker rm $name;fi
   docker run --name $name -v $current_dir/casual:/git/casual $image
   """
}

node {

   stage('Checkout')
   {
      checkout scm
   }

   stage('Build backend/Unittest Ubuntu') {

       build( 'ubuntucompile', 'casual/ubuntu', backend_builder)

       step([$class: 'XUnitBuilder',
          thresholds: [[$class: 'FailedThreshold', failureThreshold: '1']],
          tools: [[$class: 'GoogleTestType', pattern: '**/report.xml']]])

       archive includes: '**/casual.log'
       archive includes: 'casual/casual-middleware.tar'
   }
   
   stage('Build Nginx Ubuntu') {
       
       def current_dir = pwd()

       sh """
       export CASUAL_HOME=$current_dir/usr/local/casual
       export CASUAL_DOMAIN_HOME=$current_dir/test/casual
       export CASUAL_BUILD_HOME=$current_dir/casual/middleware
       export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:$current_dir/casual/middleware/common/bin
       python $current_dir/casual/thirdparty/setup/install_nginx.py
       cd $current_dir/usr/local/casual
       tar cvf $current_dir/casual-webserver.tar nginx
       """

       archive includes: '**/casual-webserver.tar'
   }


   stage('Build frontend') {

       build( 'casualfrontend', 'casual/frontend', frontend_builder)

       archive includes: '**/casual-webapp.zip'
   }
}
